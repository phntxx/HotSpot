<html>
  <head>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&v=3&libraries=geometry"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  </head>
  <body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">HotSpot</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <form class="navbar-form navbar-right">
            <div class="form-group">
              <input type="text" id="name" placeholder="name" class="form-control">
              <input type="text" id="desc" placeholder="desc" class="form-control">
              <input type="text" id="high" placeholder="high" class="form-control">
            </div>
            <button class="btn btn-success" onclick="writedata()">POST</button>
            <button class="btn btn-danger" onclick="showmap()">MAP</button>
          </form>
        </div><!--/.navbar-collapse -->
      </div>
    </nav>
    <div id="out"></div>
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD88F5C1hUomNGEvSjqbVSmE0gVU5Z_ang&callback=initMap"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/4.0.0/firebase.js"></script>
    <script>

      var config = {
        apiKey: "AIzaSyAHMCGzbw2MjuAY304_dbzuPssyiETDMvM",
        authDomain: "hotspot-ac169.firebaseapp.com",
        databaseURL: "https://hotspot-ac169.firebaseio.com",
        projectId: "hotspot-ac169",
        storageBucket: "hotspot-ac169.appspot.com",
        messagingSenderId: "252315038762"
      };
      firebase.initializeApp(config);

      function showmap(){
        window.location = "./newlocation.html";
      }

      function getLocation(callback){
        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(callback);
        }
      }

      function readdata(){
        firebase.database().ref('posts').on("child_added", function(snapshot) {
          var container = document.getElementById("out");
          if(snapshot.toJSON().created_at == new Date().toLocaleDateString()){
            var cell = document.createElement("div");

            function call2(position){
              cell.className = "row jumbotron";

              





              cell.backgroundColor = "red";
              var data = $('<div/>', {class: "col-md-11"});
                var name = $('<h1/>', {text: snapshot.toJSON().name});
                $(data).append(name);
                var high = $('<p/>', {text: snapshot.toJSON().high});
                $(data).append(high);
                var desc = $('<p/>', {text: snapshot.toJSON().desc});
                $(data).append(desc);
              $(cell).append(data);

              var locationfrom = new google.maps.LatLng({lat: position.coords.latitude, lng: position.coords.longitude});
              var locationto = new google.maps.LatLng({lat: snapshot.toJSON().lat, lng: snapshot.toJSON().lng});
              var dist = google.maps.geometry.spherical.computeDistanceBetween(locationfrom, locationto);

              var rating = $('<div/>', {class: "col-md-1"});
                var up = $('<button/>', {click: function(){buttonclicked("up", snapshot.key, snapshot.toJSON().up)}, text: "UP"});
                $(rating).append(up);
                var votes = $('<p/>', {text: snapshot.toJSON().up - snapshot.toJSON().down});
                $(rating).append(votes);
                var down = $('<button/>', {click: function(){buttonclicked("down", snapshot.key, snapshot.toJSON().down)}, text: "DOWN"});
                $(rating).append(down);
                var distance = $('<p/>', {text: "ca. " + Math.ceil(dist) + "m"});
                $(rating).append(distance);
              $(cell).append(rating);

              container.appendChild(cell);

            }

            getLocation(call2);


          }
        });
      }

      function buttonclicked(action, id, current){
        if(action == "up"){
          firebase.database().ref().child('/posts/' + id).update({up: current + 1});
          window.location = "backend.html";
        } else if(action == "down"){
          firebase.database().ref().child('/posts/' + id).update({down: current + 1});
          window.location = "backend.html";
        }
      }

      function writedata(){
        var name = document.getElementById("name").value;
        var desc = document.getElementById("desc").value;
        var high = document.getElementById("high").value;

        function call(position){
          if(name != null && desc != null && high != null && lat != null && lng != null){
            firebase.database().ref('posts').push({
              name: name,
              high: high,
              desc: desc,
              created_at: new Date().toLocaleDateString(),
              lat: position.coords.latitude,
              lng: position.coords.longitude,
              up: 0,
              down: 0
            });
          } else {
            window.location = "./backend.html";
          }
        }

        getLocation(call);
      }

      readdata();

    </script>
  </body>
</html>
